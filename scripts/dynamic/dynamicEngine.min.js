const dynamicEngine={triggerContextChange(e){for(var t in dynamicEngine.expressions._evaluationRequests){t=dynamicEngine.expressions._evaluationRequests[t];t.context&&t._context.__handler__._usedProperties[e.contextProperty]&&dynamicEngine.expressions._evaluate(t)}},getGlobalSettings(e,t){t(null,{})},_isServer(){return!("undefined"!=typeof window&&window.document)},expressions:{_evaluationRequests:{},evaluate(e,t){var n=(e=e||{})["id"],e={callback:t,options:e,id:n||dynamicEngine.expressions._nanoid(),destroy(){dynamicEngine.expressions._destroyRequest(this.id)}};return n&&dynamicEngine.expressions._destroyRequest(n),dynamicEngine.expressions._evaluate(e),e},_evaluate(r){const i=dynamicEngine["expressions"],{id:c,callback:d}=r,u=r.options?.expression||"";i._prepareContext(r.options,(e,t)=>{try{var n={_usedProperties:{},get(e,t){return"__handler__"===t?this:t in e?(this._usedProperties[t]=!0,e[t]):void 0},set(){throw"not_allowed"}},a="`"+u+"`";r._context=new Proxy(t,n),r.context=t;var s=Function(`"use strict"; const context = this;return (${a})`).bind(r._context)(),o=(i._evaluationRequests[c]=r)._context.data.__handler__._usedProperties;dynamicEngine.datasources._fetchNeededDatasources({usedDatasources:o,extendedDatasources:r.options.extendedDatasources},(e,t)=>e?console.error("Error occurred while fetching data: ",e):void dynamicEngine.triggerContextChange({contextProperty:"data",data:t})),r.callback(null,s)}catch(e){d(e)}})},_destroyRequest(e){delete dynamicEngine.expressions._evaluationRequests[e]},_getBaseContext(e,t){t(null,{})},getContext(e,t){t(null,{})},_prepareContext(a,s){dynamicEngine.expressions._getBaseContext(null,(e,n)=>{dynamicEngine.expressions.getContext({request:a},(e,t)=>{Object.assign(n,t,a.extendedContext),dynamicEngine.datasources._addDatasourcesData({baseContext:n}),s(null,n)})})},_nanoid(e=21){return crypto.getRandomValues(new Uint8Array(e)).reduce((e,t)=>e+=(t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():62<t?"-":"_","")}},datasources:{datasourcesData:{},requestedDatasources:{},_addDatasourcesData({baseContext:e}){var t=this.datasourcesData;e.data=new Proxy(t,{_usedProperties:{},get(e,t){return"__handler__"===t?this:(this._usedProperties[t]=!0,e[t])}})},_fetchNeededDatasources({usedDatasources:s,extendedDatasources:t},o){s&&0<Object.keys(s).length&&dynamicEngine.datasources._getDatasources(null,(e,n)=>{if(e)return console.error("Error occurred while fetching data: ",e);if(n||t){n=n||[],t&&(n=n.concat(t));for(let t in s){var a;this.requestedDatasources[t]&&!(5e3<new Date-this.requestedDatasources[t].lastTimeFetched)||(a=n.find(e=>e.id===t))&&this.fetchDatasource({datasource:a},o)}}})},fetchDatasource({datasource:e},t){e.lastTimeFetched=new Date,"api"===(this.requestedDatasources[e.id]=e).type&&dynamicEngine.datasources._fetchApi({datasource:e},t)},_fetchApi({datasource:s},o){var e=dynamicEngine.datasources._evaluateDatasourceConfiguration([s.configuration?.url,s.configuration?.method,s.configuration?.headers,s.configuration?.body]);Promise.all(e).then(([e,,t,n])=>{const a={};t&&(a.headers=t),n&&(a.body=n),fetch(e,a).then(e=>e.json()).then(e=>{dynamicEngine.datasources.datasourcesData[s.id]=e,o(null,e)}).catch(e=>{o(e,null)})}).catch(e=>{o(e,null)})},_evaluateDatasourceConfiguration(e){const t=[];for(const s of e)s?t.push(new Promise((n,a)=>{dynamicEngine.expressions.evaluate({expression:s},(e,t)=>{e?a(e):n(t)})})):t.push(Promise.resolve(""));return t},_getDatasources(e,n){dynamicEngine.getGlobalSettings(null,(e,t)=>e?n(e):t?.appDatasources&&0<t.appDatasources.length?n(null,t.appDatasources):void n(null,null))}}};
//# sourceMappingURL=dynamicEngine.min.js.map
