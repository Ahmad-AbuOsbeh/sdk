const dynamicEngine={triggerContextChange(e){for(var t in dynamicEngine.expressions._evaluationRequests){t=dynamicEngine.expressions._evaluationRequests[t];t.context&&t._context.__handler__._usedProperties[e.contextProperty]&&dynamicEngine.expressions._evaluate(t)}},getGlobalSettings(e,t){t(null,{})},_isServer(){return!("undefined"!=typeof window&&window.document)},expressions:{_evaluationRequests:{},evaluate(e,t){var n=(e=e||{})["id"],e={callback:t,options:e,id:n||dynamicEngine.expressions._nanoid(),destroy(){dynamicEngine.expressions._destroyRequest(this.id)}};return n&&dynamicEngine.expressions._destroyRequest(n),dynamicEngine.expressions._evaluate(e),e},_evaluate(o){const i=dynamicEngine["expressions"],{id:c,callback:d}=o;let u=o.options?.expression||"";i._prepareContext(o.options,(e,t)=>{try{var n={_usedProperties:{},get(e,t){return"__handler__"===t?this:t in e?(this._usedProperties[t]=!0,e[t]):void 0},set(){throw"not_allowed"}};u.includes("buildfire-repeat")&&(u=dynamicEngine.expressions.handleRepeaters({expression:u,context:t}));var a="`"+u+"`";o._context=new Proxy(t,n),o.context=t;var s=Function(`"use strict"; const context = this;return (${a})`).bind(o._context)(),r=(i._evaluationRequests[c]=o)._context.data.__handler__._usedProperties;dynamicEngine.datasources._fetchNeededDatasources({usedDatasources:r,extendedDatasources:o.options.extendedDatasources},(e,t)=>e?console.error("Error occurred while fetching data: ",e):void dynamicEngine.triggerContextChange({contextProperty:"data",data:t})),d(null,{evaluatedExpression:s,evaluationRequest:o})}catch(e){d(e)}})},_destroyRequest(e){delete dynamicEngine.expressions._evaluationRequests[e]},_getBaseContext(e,t){t(null,{})},getContext(e,t){t(null,{})},_prepareContext(a,s){dynamicEngine.expressions._getBaseContext(null,(e,n)=>{dynamicEngine.expressions.getContext({request:a},(e,t)=>{Object.assign(n,t,a.extendedContext),dynamicEngine.datasources._addDatasourcesData({context:n}),s(null,n)})})},handleRepeaters({expression:e,context:t}){let n=document.createElement("div");return n.innerHTML=e,dynamicEngine.expressions._checkNestedRepeaters({element:n,context:t,scope:{}}),n.innerHTML},_handleRepeaters({element,context,scope}){scope=JSON.parse(JSON.stringify(scope));const repeatAttr=element.getAttribute("buildfire-repeat");element.removeAttribute("buildfire-repeat");let[loopVar,arrayName]=repeatAttr.split(" in ");arrayName=arrayName.replace(/(^(?! *context\.).*)/,(e,t)=>{var n=arrayName.split(".")[0];if(scope[n])return t.replace(n,scope[n])});try{const array=eval(`${arrayName}`);array?.forEach((e,t)=>{scope[loopVar]=`${arrayName}[${t}]`;const n=element.cloneNode(!0);dynamicEngine.expressions._checkNestedRepeaters({element:n,context:context,scope:scope}),n.innerHTML=n.innerHTML.replace(/\${((?! *context\.)[^{}]*)}/g,(e,t)=>"${"+t.replace(loopVar,scope[loopVar])+"}"),element.parentNode.appendChild(n)}),element.remove()}catch(err){element.remove(),console.error(err)}},_checkNestedRepeaters({element:e,context:t,scope:n}){var a=e.querySelector("[buildfire-repeat]");a&&dynamicEngine.expressions._handleRepeaters({element:a,context:t,scope:n}),e.querySelector("[buildfire-repeat]")&&dynamicEngine.expressions._checkNestedRepeaters({element:e,context:t,scope:n})},_nanoid(e=21){return crypto.getRandomValues(new Uint8Array(e)).reduce((e,t)=>e+=(t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():62<t?"-":"_","")}},datasources:{datasourcesData:{},requestedDatasources:{},_addDatasourcesData({context:e}){var t=this.datasourcesData;e.data=new Proxy(t,{_usedProperties:{},get(e,t){return"__handler__"===t?this:(this._usedProperties[t]=!0,e[t])}})},_fetchNeededDatasources({usedDatasources:s,extendedDatasources:r},o){s&&0<Object.keys(s).length&&dynamicEngine.datasources._getDatasources(null,(e,t)=>{if(e)return console.error("Error occurred while fetching data: ",e);if(t||r){t=t||[];let n=JSON.parse(JSON.stringify(t));if(r){let e=[];t.forEach(t=>{r.find(e=>e.id===t.id)||e.push(t)}),n=[...e,...r]}for(let t in s){var a;this.requestedDatasources[t]&&!(5e3<new Date-this.requestedDatasources[t].lastTimeFetched)||(a=n.find(e=>e.id===t))&&this.fetchDatasource({datasource:a},o)}}})},fetchDatasource({datasource:e},t){e.lastTimeFetched=new Date,"api"===(this.requestedDatasources[e.id]=e).type&&dynamicEngine.datasources._fetchApi({datasource:e},t)},_fetchApi({datasource:s},r){var e=dynamicEngine.datasources._evaluateDatasourceConfiguration([s.configuration?.url,s.configuration?.method,s.configuration?.headers,s.configuration?.body]);Promise.all(e).then(([e,,t,n])=>{const a={};t&&(a.headers=t),n&&(a.body=n),fetch(e,a).then(e=>e.json()).then(e=>{dynamicEngine.datasources.datasourcesData[s.id]=e,r(null,e)}).catch(e=>{r(e,null)})}).catch(e=>{r(e,null)})},_evaluateDatasourceConfiguration(e){const t=[];for(const s of e)s?t.push(new Promise((n,a)=>{dynamicEngine.expressions.evaluate({expression:s},(e,t)=>{e?a(e):(t.evaluationRequest.destroy(),n(t.evaluatedExpression))})})):t.push(Promise.resolve(""));return t},_getDatasources(e,n){dynamicEngine.getGlobalSettings(null,(e,t)=>e?n(e):t?.appDatasources&&0<t.appDatasources.length?n(null,t.appDatasources):void n(null,null))}}};
//# sourceMappingURL=dynamicEngine.min.js.map
