tinymce.PluginManager.add("bf_layouts",function(e,t){let a,r=window.innerHeight>600?600:window.innerHeight-20;function n(n){let o="",s="Select Layout",u={text:"Cancel",type:"cancel"},l=[u,{text:"Insert",name:"Insert Layout",type:"custom",primary:!0}];if(n){s="Edit Layout",l=[u,{text:"Save",name:"Change Layout",type:"custom",primary:!0}];let e={layoutData:JSON.parse(unescape(a.dataset.bfLayout))},t=JSON.stringify(e);o=`?data=${encodeURIComponent(t)}`}e.windowManager.openUrl({title:s,url:`${t}/dialog.html${o}`,width:500,height:r,buttons:l,onAction:(e,t)=>{"Insert Layout"!==t.name&&"Change Layout"!==t.name||e.sendMessage({message:"getLayout"})},onMessage:(t,r)=>{let o=r.data.content,s=r.mceAction;if(o&&"insertLayout"===s){let r=o.cssContent,s=e.dom.doc.body.querySelector("style[data-layout-name="+o.id+"]");if(n){o.isRepeaterTurnedOn||(a.hasAttribute("buildfire-repeat")?a.removeAttribute("buildfire-repeat"):a.querySelector("[buildfire-repeat]")&&a.querySelector("[buildfire-repeat]").removeAttribute("buildfire-repeat")),a.id=o.id,o.hasLinkData&&o.wasLinkDataPageOpened&&i({layoutData:o,layoutWrapperElement:a});let t={};t.id=o.id,t.cssUrl=o.cssUrl,t.htmlUrl=o.htmlUrl,t.wasDataLinked=o.hasLinkData,t.repeaterReplacementExpression=o.repeaterReplacementExpression;let r=escape(JSON.stringify(t));a.setAttribute("data-bf-layout",r),a.setAttribute("data-layout-name",o.id),e.selection.collapse(),e.isNotDirty=!1,e.fire("change")}else{let t=o.htmlContent,a=document.createElement("div");a.id=o.id,a.innerHTML=t,a.querySelectorAll("img").forEach(e=>{e.src=e.src&&e.src.replace("https://pluginserver.buildfire.com","https://pluginserver.appdocumentation.com"),e.setAttribute("src",e.src)}),o.hasLinkData&&i({layoutData:o,layoutWrapperElement:a});let r={};r.id=o.id,r.cssUrl=o.cssUrl,r.htmlUrl=o.htmlUrl,r.wasDataLinked=o.hasLinkData,r.repeaterReplacementExpression=o.repeaterReplacementExpression;let n=escape(JSON.stringify(r));a.setAttribute("data-bf-layout",n),a.setAttribute("data-layout-name",o.id),e.insertContent(a.outerHTML+"&nbsp;")}if(s)s&&n&&(s.innerHTML=r);else{let t=document.createElement("style");t.setAttribute("data-layout-name",o.id),t.innerHTML=r,e.dom.doc.body.appendChild(t)}t.close()}else if("showExpressionBuilder"===s){let e={string:r.data.string};buildfire.dynamic.expressions.showDialog(e,(e,a)=>{if(e)return console.error(e);a&&t.sendMessage({message:"insertExpression",expression:a})})}else"getLayoutElement"===s&&t.sendMessage({message:"sendLayoutHtml",layoutElement:a.outerHTML})}})}e.ui.registry.addButton("bf_edit_layout",{icon:"edit-block",tooltip:"Edit layout",onAction:function(){n(!0)}}),e.ui.registry.addContextToolbar("editBfLayout",{predicate:function(e){return e.dataset.bfLayout&&(a=e),e.dataset.bfLayout},items:"bf_edit_layout",position:"node",scope:"node"}),e.ui.registry.addMenuItem("bf_insertLayout",{text:"Insert layout",onAction:function(){n(!1)}}),e.ui.registry.addMenuItem("bf_editLayout",{text:"Edit layout",icon:"edit-block",onAction:function(){n(!0)}}),e.ui.registry.addMenuItem("bf_copyLayout",{text:"Copy layout",icon:"copy",onAction:function(){e.execCommand("mceSelectNode",!1,a),e.execCommand("Copy")}}),e.ui.registry.addMenuItem("bf_deleteLayout",{text:"Delete layout",icon:"remove",onAction:function(){a.parentNode.removeChild(a),e.isNotDirty=!1,e.fire("change")}}),e.ui.registry.addMenuItem("bf_insertBeforeLayout",{text:"Insert before layout",icon:"chevron-left",onAction:function(){a.insertAdjacentHTML("beforebegin","<p><br></p>")}}),e.ui.registry.addMenuItem("bf_insertAfterLayout",{text:"Insert after layout",icon:"chevron-right",onAction:function(){a.insertAdjacentHTML("afterend","<p><br></p>")}}),e.ui.registry.addContextMenu("bf_customLayouts",{update:function(e){if(e.dataset.bfLayout)return a=e,"bf_editLayout bf_copyLayout bf_deleteLayout bf_insertBeforeLayout bf_insertAfterLayout";for(;e.dataset.bfLayout||"BODY"!==e.nodeName;){if(!(e=e.parentElement)||!e.dataset)return"";if(e.dataset.bfLayout)return a=e,"bf_editLayout bf_copyLayout bf_deleteLayout bf_insertBeforeLayout bf_insertAfterLayout"}return""}});const i=e=>{let{layoutData:t,layoutWrapperElement:a}=e,r=t.repeaterReplacementExpression;if(r){let e=r.replace(/[?]/g,"").replace(/\.\[/g,"["),n=e.search(/\[[0-9]+\]/),i=e.slice(0,n),o=a.querySelector(t.repeatedSelector);o?o.setAttribute("buildfire-repeat",`layoutItem in ${i}`):t.repeatedSelector==`div#${t.id}`&&a.setAttribute("buildfire-repeat",`layoutItem in ${i}`)}t.expressionFields.forEach(e=>{let t=e.value||"",n=a.querySelector(e.selector);n&&(r&&(t=t.replaceAll(r,"layoutItem")),e.attribute?"src"==e.attribute&&"IMG"==n.nodeName?t.search(/\${[^{}]*}/)>-1?n.setAttribute("data-expr-src",t):(n.removeAttribute("data-expr-src"),n.setAttribute("data-mce-src",t),n.setAttribute("src",t)):n.setAttribute(e.attribute,t):n.innerHTML=t)})};return{getMetadata:function(){return{name:"Layouts Plugin"}}}});