if("undefined"==typeof buildfire)throw"please add buildfire.js first to use buildfire components";void 0===buildfire.components&&(buildfire.components={});class Rating{constructor(e={}){e.data||(e.data={}),this.id=e.id||void 0,this.isActive="boolean"!=typeof e.data.isActive||e.data.isActive,this.createdOn=e.data.createdOn||new Date,this.createdBy=e.data.createdBy||void 0,this.lastUpdatedOn=e.data.lastUpdatedOn||void 0,this.lastUpdatedBy=e.data.lastUpdatedBy||void 0,this.deletedOn=e.data.deletedOn||void 0,this.deletedBy=e.data.deletedBy||void 0,this.user=e.data.user||{_id:"",displayName:"",imageUrl:""},this.ratingId=e.data.ratingId||void 0,this.rating=e.data.rating||void 0,this.comment=e.data.comment||"",this.images=e.data.images||[]}toJSON(){return{id:this.id,isActive:this.isActive,createdOn:this.createdOn,createdBy:this.createdBy,lastUpdatedOn:this.lastUpdatedOn,lastUpdatedBy:this.lastUpdatedBy,deletedOn:this.deletedOn,deletedBy:this.deletedBy,user:this.user,ratingId:this.ratingId,rating:this.rating,comment:this.comment,images:this.images,_buildfire:{index:{number1:this.isActive?1:0,date1:this.createdOn,array1:[this.rating,this.user._id],string1:this.ratingId}}}}}class Ratings{static get TAG(){return"rating"}static search(e,t){buildfire.appData.search(e,Ratings.TAG,(e,n)=>e?t(e):t(null,n.map(e=>new Rating(e))))}static findRatingByUser(e,t,n){Ratings.search({filter:{"_buildfire.index.array1":t,"_buildfire.index.string1":e}},(e,t)=>e?n(e):n(null,t[0]))}static add(e,t){return e instanceof Rating?e.user&&e.user._id?void Ratings.search({filter:{"_buildfire.index.array1":e.user._id,"_buildfire.index.string1":e.ratingId}},(n,a)=>n?t(n):a&&a.length?t(new Error("User already rated item")):void(a&&0!==a.length||(e.createdOn=new Date,buildfire.appData.insert(e.toJSON(),Ratings.TAG,!1,(e,n)=>{if(e)return t(e);n=new Rating(n),Summaries.addRating(n,(e,a)=>t(null,{rating:n,summary:a}))})))):t(new Error("User must be logged in")):t(new Error("Only Rating instance can be used"))}static set(e,t,n){if(!(t instanceof Rating))return n(new Error("Only Rating instance can be used"));t.lastUpdatedOn=new Date,buildfire.appData.update(t.id,t.toJSON(),Ratings.TAG,(t,a)=>{if(t)return n(t);a=new Rating(a),Summaries.updateRating(e,a,(e,t)=>n(null,{rating:a,summary:t}))})}static del(e,t){if(!(e instanceof Rating))return t(new Error("Only Rating instance can be used"));buildfire.appData.delete(e.id,Ratings.TAG,(n,a)=>{if(n)return t(n);Summaries.deleteRating(e,(n,a)=>(buildfire.messaging.sendMessageToControl({type:"ratings"}),t(null,{rating:e,summary:a})))})}static softDel(e,t){if(!(e instanceof Rating))return t(new Error("Only Rating instance can be used"));let n=e.isActive;e.isActive=!1,buildfire.appData.update(e.id,e.toJSON(),Ratings.TAG,(a,i)=>a?t(a):n?void Summaries.deleteRating(e,(n,a)=>(buildfire.messaging.sendMessageToControl({type:"ratings"}),t(null,e))):t(null,e))}}class Summary{constructor(e={}){e.data||(e.data={}),this.id=e.id||void 0,this.ratingId=e.data.ratingId||null,this.count=e.data.count||0,this.total=e.data.total||0}toJSON(){return{id:this.id,ratingId:this.ratingId,count:this.count,total:this.total,_buildfire:{index:{string1:this.ratingId}}}}}class Summaries{static get TAG(){return"fivestarsummary"}static search(e,t){buildfire.appData.search(e,Summaries.TAG,(e,n)=>e?t(e):t(null,n.map(e=>new Summary(e))))}static addRating(e,t){const n={filter:{"_buildfire.index.string1":e.ratingId}};buildfire.appData.search(n,Summaries.TAG,(n,a)=>{if(n)return t(n);let i=a[0];i?((i=new Summary(i)).count++,i.total+=e.rating,buildfire.appData.update(i.id,i.toJSON(),Summaries.TAG,(e,n)=>e?t(e):t(null,new Summary(n)))):(i=new Summary({data:{ratingId:e.ratingId,count:1,total:e.rating}}),buildfire.appData.insert(i.toJSON(),Summaries.TAG,!1,(e,n)=>e?t(e):t(null,new Summary(n))))})}static updateRating(e,t,n){const a={filter:{"_buildfire.index.string1":t.ratingId}};buildfire.appData.search(a,Summaries.TAG,(a,i)=>{if(a)return n(a);let r=new Summary(i[0]);r.total+=t.rating,r.total-=e.rating,buildfire.appData.update(r.id,r.toJSON(),Summaries.TAG,(e,t)=>e?n(e):n(null,new Summary(t)))})}static deleteRating(e,t){const n={filter:{"_buildfire.index.string1":e.ratingId}};buildfire.appData.search(n,Summaries.TAG,(n,a)=>{if(n)return t(n);let i=new Summary(a[0]);i.total-=e.rating,i.count--,buildfire.appData.update(i.id,i.toJSON(),Summaries.TAG,(e,n)=>e?t(e):t(null,new Summary(n)))})}}const FULL_STAR="&#9733;",ADMIN_TAG="bf_ratings_admin";function getNotRatedUI(e){for(let t=0;t<5;t++){let t=document.createElement("span");t.innerHTML=FULL_STAR,t.style.opacity="0.3",e.appendChild(t)}}function injectRatings(e={},t){let n=e.elements;void 0===n&&(n=document.querySelectorAll("[data-rating-id]"));let a=e.ratingIds;void 0===a&&(a=Array.from(n).map(e=>e.dataset.ratingId));const i={filter:{"_buildfire.index.string1":{$in:a}}};Summaries.search(i,(i,r)=>{if(i)return console.error(i);a.forEach((a,i)=>{let d=r.find(e=>e.ratingId===a);d||(e.notRated=!0),e.summary=d,injectAverageRating(n[i],a,e),"function"==typeof t&&t()})})}function injectAverageRating(e,t,n){if(!e)return console.error("Container not found in DOM");e.innerHTML="";const a={filter:{"_buildfire.index.string1":t}};if(n.notRated)return getNotRatedUI(e);if(n&&n.summary){let t=n.summary.total/n.summary.count;createStarsUI(e,t,n.hideAverage)}else Summaries.search(a,(t,a)=>{if(t)return console.error(t);if(!a||!a[0]||0===a[0].count)return getNotRatedUI(e);let i=a[0].total/a[0].count;createStarsUI(e,i,n&&n.hideAverage)})}function openAddRatingScreen(e,t={enableImages:!0,headerText:"Leave a review"},n=(()=>{})){buildfire.auth.getCurrentUser((a,i)=>{if(a||!i)return buildfire.auth.login({allowCancel:!0,showMenu:!0},(t,n)=>{if(n)return openAddRatingScreen(e)});Ratings.findRatingByUser(e,i._id,(a,r)=>{if(buildfire.navigation.onBackButtonClick=(()=>{closeAddRatingScreen(),buildfire.navigation.restoreBackButtonClick()}),r&&!r.isActive){let e=document.createElement("div");return e.className="add-rating-screen",e.style.padding="10px",e.innerText="Your rating has been removed for violating community guildelines",document.body.appendChild(e)}let d;r?d=new Rating({data:r}):r=new Rating({data:{createdBy:i._id,user:{_id:i._id,displayName:i.displayName,imageUrl:i.imageUrl},ratingId:e}});let s=document.createElement("div");s.className="add-rating-screen";let l=document.createElement("div");l.className="add-rating-screen-content";let c=document.createElement("div");c.className="add-rating-header";let o=document.createElement("div");o.className="cancel-rating-button",o.innerText="Cancel",o.addEventListener("click",()=>{closeAddRatingScreen()});let m=document.createElement("div");m.className="add-rating-title",m.innerText=r.id?"Update Rating":"Add Rating",c.appendChild(o),c.appendChild(m);let u=document.createElement("div");u.className="add-rating-subtitle",u.innerText=t.headerText;let g=()=>{for(let e=0;e<5;e++){document.getElementById("stars"+e).style.opacity=e<r.rating?"1":"0.3"}},p=document.createElement("div");p.className="rating-stars";for(let e=0;e<5;e++){let t=document.createElement("div");t.id="stars"+e,t.addEventListener("click",function(){r.rating=e+1,g()}),t.innerHTML=FULL_STAR,t.style.color="#fcb040",p.appendChild(t)}let f=()=>{v.innerText=r.comment?r.comment:"Write a review..."},h=document.createElement("div");h.className="add-rating-subtitle",h.innerText="Write a comment:";let v=document.createElement("div");v.className="text-area",v.addEventListener("click",()=>{buildfire.input.showTextDialog({placeholder:"Write a review...",saveText:"Save",defaultValue:"Write a review..."!==v.innerText?v.innerText:"",attachments:{images:{enable:!0,multiple:!0}}},(e,t)=>{e||t.cancelled||(r.comment=t.results[0].textValue,r.images=[...r.images,...t.results[0].images],f(),b())})});let y=document.createElement("images");y.className="review-images-container";const b=()=>{y.innerHTML="",r.images.forEach((e,t)=>{let n=document.createElement("div");n.className="review-image-container";let a=document.createElement("div");a.className="review-image-delete",a.innerHTML="âœ–",a.style.background="red",a.style.color="white";let i=document.createElement("img");i.className="review-image",i.src=buildfire.imageLib.resizeImage(e,{size:"s",aspect:"1:1"}),n.appendChild(i),n.appendChild(a),n.addEventListener("click",()=>{(e=>{r.images.splice(e,1),b()})(t)}),y.appendChild(n)})};let R=document.createElement("div");R.className="submit-button",R.innerText=r.id?"Update Rating":"Add Rating",R.addEventListener("click",()=>{r.id?Ratings.set(d,r,(e,t)=>{closeAddRatingScreen(),buildfire.messaging.sendMessageToControl({type:"ratings"}),n(e,t)}):Ratings.add(r,(e,t)=>{closeAddRatingScreen(),buildfire.messaging.sendMessageToControl({type:"ratings"}),n(e,t)})}),l.appendChild(c),l.appendChild(u),l.appendChild(p),l.appendChild(h),l.appendChild(v),l.appendChild(y),l.appendChild(R),s.appendChild(l),document.body.appendChild(s),b(),g(),f()})})}function closeAddRatingScreen(){let e=document.querySelector(".add-rating-screen");if(!e)return buildfire.navigation.restoreBackButtonClick();document.body.removeChild(e),buildfire.navigation.restoreBackButtonClick()}function createRatingUI(e){let t=document.createElement("div");t.className="ratings-screen-rating",t.id=e.id,t.dataset.rating=JSON.stringify(e);let n=document.createElement("div");n.className="rating-header",t.appendChild(n);let a=document.createElement("img");a.className="rating-user-image",a.src=e.user&&e.user.imageUrl?e.user.imageUrl:"https://pluginserver.buildfire.com/styles/media/avatar-placeholder.png",a.src=buildfire.imageLib.resizeImage(a.src,{size:"s",aspect:"1:1"}),n.appendChild(a);let i=document.createElement("div");i.className="rating-name-and-stars",n.appendChild(i);let r=document.createElement("div");r.className="rating-user-display-name",r.innerText=e.user&&e.user.displayName?e.user.displayName:"Unknown User",i.appendChild(r);let d=document.createElement("div");d.className="rating-user-stars",i.appendChild(d);let s=document.createElement("span");s.className="stars-span",createStarsUI(s,Number(e.rating),!0);let l=document.createElement("span");l.className="rating-time-ago",l.innerHTML=getTimeAgo(new Date(e.createdOn)),d.appendChild(s),d.appendChild(l);let c=document.createElement("div");c.className="rating-review",t.appendChild(c);let o=document.createElement("div");if(o.className="rating-review-text",o.innerText=e.comment.length>120?e.comment.slice(0,120)+"...":e.comment,e.comment.length>120){let t=document.createElement("a");t.innerText="see more",t.addEventListener("click",()=>{o.innerText=e.comment}),o.append(t)}c.appendChild(o);let m=document.createElement("div");m.className="rating-review-images",c.appendChild(m);for(let t=0;t<e.images.length;t++){const n=e.images[t];let a=document.createElement("img");a.className="rating-review-image",a.src=buildfire.imageLib.resizeImage(n,{size:"m",aspect:"1:1"}),m.appendChild(a)}return t}function openRatingsScreen(e){let t=document.createElement("div");t.className="ratings-screen",buildfire.spinner.show(),buildfire.navigation.onBackButtonClick=(()=>{closeRatingsScreen()});let n=document.createElement("div");n.className="ovarall-rating-container";let a=document.createElement("h5");a.innerText="Overall rating",a.style.fontWeight=400,n.appendChild(a);let i=document.createElement("h6");n.appendChild(i);let r=document.createElement("div");r.className="overall-rating-stars",n.appendChild(r),t.appendChild(n),Summaries.search({filter:{"_buildfire.index.string1":e}},(e,t)=>{if(e)return console.error(e);if(!t[0])return getNotRatedUI(r);const{count:n,total:a}=t[0];createStarsUI(r,a/n,!0),i.innerText="Based on "+n+" Reviews"});let d=document.createElement("div");d.className="empty-state-container";let s=document.createElement("h5");s.innerText="No reivews yet. Be the first to leave a review!",d.appendChild(s);let l=document.createElement("div");l.innerText="Leave a review",l.addEventListener("click",()=>{closeRatingsScreen(),openAddRatingScreen(e)}),d.appendChild(l),checkIfUserIsAdmin(n=>{console.log(n),Ratings.search({filter:{"_buildfire.index.string1":e,"_buildfire.index.number1":1}},(e,a)=>{if(e)return console.error(e);0===a.length&&t.appendChild(d),a.forEach(e=>{let a=createRatingUI(e);n&&addControlsToRating(a),t.appendChild(a)}),document.body.appendChild(t),buildfire.spinner.hide()})})}function checkIfUserIsAdmin(e){buildfire.auth.getCurrentUser((t,n)=>!t&&n&&n.tags?(Object.keys(n.tags).forEach(t=>{if(-1!=n.tags[t].findIndex(e=>e.tagName==ADMIN_TAG))return e(!0)}),e(!1)):e(!0))}function getTimeAgo(e){let t=Math.floor((new Date-e)/1e3),n=Math.floor(t/31536e3);return n>1?n+" years ago":(n=Math.floor(t/2592e3))>1?n+" months ago":(n=Math.floor(t/86400))>1?n+" days ago":(n=Math.floor(t/3600))>1?n+" hours ago":(n=Math.floor(t/60))>1?n+" minutes ago":Math.floor(t)+" seconds ago"}function closeRatingsScreen(){let e=document.querySelector(".ratings-screen");document.body.removeChild(e),buildfire.navigation.restoreBackButtonClick()}function createStarsUI(e,t,n){e.innerHTML="",e.classList.add("flex-center");for(let n=1;n<6;n++){let a=document.createElement("span");if(a.innerHTML=FULL_STAR,a.className="full-star",n>t&&n===Math.trunc(t)+1){a.innerHTML=`<span style="opacity: 0.3">${FULL_STAR}</span>`;let e=100*(t-Math.trunc(t));a.style.position="relative";let n=document.createElement("span");n.innerHTML=FULL_STAR,n.className="half-star",n.style.backgroundImage=`linear-gradient(to right, currentColor ${e}%, transparent ${e}%)`,a.appendChild(n)}else n>t&&(a.style.opacity="0.3");e.appendChild(a)}if(!n){let n=document.createElement("span");n.className="average-rating",n.innerText=t.toFixed(1),e.appendChild(n)}}function injectRatingComponent(e,t,n,a){e.innerHTML="";let i=document.createElement("div");i.className="ratings";let r=document.createElement("div");r.className="ratings-head";let d=document.createElement("div");d.className="ratings-text primary-color",d.innerText="Ratings";let s=document.createElement("div");s.className="view-all-button",s.innerText="View All",s.addEventListener("click",()=>{openRatingsScreen(t)}),r.appendChild(d),r.appendChild(s);let l=document.createElement("div");l.className="reviews-container";let c=document.createElement("div");c.className="add-rating-button",c.innerText="+ ADD RATING",c.addEventListener("click",()=>{openAddRatingScreen(t,a,(e,t)=>{o()})}),i.appendChild(r),i.appendChild(l),i.appendChild(c);const o=()=>{Summaries.search({filter:{"_buildfire.index.string1":t}},(e,t)=>{if(e)return console.err(e);if(!t||!t[0]||0===t[0].count)return getNotRatedUI(l);let n=t[0].total/t[0].count;createStarsUI(l,n,!0)})};Ratings.search({filter:{"_buildfire.index.string1":t,"_buildfire.index.array1":n}},(e,t)=>{if(e)return console.error(e);t&&t[0]&&(c.innerText="EDIT RATING")}),o(),e.appendChild(i)}function addControlsToRating(e){let t=JSON.parse(e.dataset.rating);if(!(t=new Rating({data:t,id:t.id})).isActive){let t=document.createElement("div");t.innerText="This rating has been blocked",e.appendChild(t)}let n=document.createElement("div"),a=document.createElement("button");a.innerText="Delete",a.className="delete-button",a.addEventListener("click",()=>{buildfire.notifications.confirm({title:"Are you sure?",message:"Are you sure you want to remove this review?",confirmButton:{text:"Yes",key:"yes",type:"danger"},cancelButton:{text:"No",key:"no",type:"default"}},function(e,n){(e&&2!==e||n&&"yes"===n.selectedButton.key)&&Ratings.del(t,(e,t)=>{let n=document.getElementById(t.rating.id);n.parentElement.removeChild(n)})})});let i=document.createElement("button");i.innerText="Block",i.className="delete-button",i.addEventListener("click",()=>{buildfire.notifications.confirm({title:"Are you sure you want to block this review?",message:"User will not be able to submit another review for this item",confirmButton:{text:"Yes",key:"yes",type:"danger"},cancelButton:{text:"No",key:"no",type:"default"}},function(e,n){(e&&2!==e||n&&"yes"===n.selectedButton.key)&&Ratings.softDel(t,(e,t)=>{})})}),n.appendChild(a),n.appendChild(i),e.appendChild(n)}buildfire.components.ratingSystem={injectRatings:injectRatings,injectRatingComponent:injectRatingComponent,openAddRatingScreen:openAddRatingScreen,openRatingsScreen:openRatingsScreen};