if("undefined"==typeof buildfire)throw"please add buildfire.js first to use buildfire components";void 0===buildfire.components&&(buildfire.components={});class Rating{constructor(e={}){e.data||(e.data={}),this.id=e.id||void 0,this.isActive="boolean"!=typeof e.data.isActive||e.data.isActive,this.createdOn=e.data.createdOn||new Date,this.createdBy=e.data.createdBy||void 0,this.lastUpdatedOn=e.data.lastUpdatedOn||void 0,this.lastUpdatedBy=e.data.lastUpdatedBy||void 0,this.deletedOn=e.data.deletedOn||void 0,this.deletedBy=e.data.deletedBy||void 0,this.user=e.data.user||{_id:"",displayName:"",imageUrl:""},this.ratingId=e.data.ratingId||void 0,this.rating=e.data.rating||void 0,this.comment=e.data.comment||"",this.images=e.data.images||[]}toJSON(){return{id:this.id,isActive:this.isActive,createdOn:this.createdOn,createdBy:this.createdBy,lastUpdatedOn:this.lastUpdatedOn,lastUpdatedBy:this.lastUpdatedBy,deletedOn:this.deletedOn,deletedBy:this.deletedBy,user:this.user,ratingId:this.ratingId,rating:this.rating,comment:this.comment,images:this.images,_buildfire:{index:{number1:this.isActive?1:0,date1:this.createdOn,array1:[this.rating,this.user._id],string1:this.ratingId}}}}}class Ratings{static get TAG(){return"rating"}static search(e,t){buildfire.appData.search(e,Ratings.TAG,(e,n)=>e?t(e):t(null,n.map(e=>new Rating(e))))}static findRatingByUser(e,t,n){Ratings.search({filter:{"_buildfire.index.array1":t,"_buildfire.index.string1":e}},(e,t)=>e?n(e):n(null,t[0]))}static add(e,t){return e instanceof Rating?e.user&&e.user._id?void Ratings.search({filter:{"_buildfire.index.array1":e.user._id,"_buildfire.index.string1":e.ratingId}},(n,a)=>n?t(n):a&&a.length?t(new Error("User already rated item")):void(a&&0!==a.length||(e.createdOn=new Date,buildfire.appData.insert(e.toJSON(),Ratings.TAG,!1,(e,n)=>{if(e)return t(e);n=new Rating(n),Summaries.addRating(n,(e,a)=>t(null,{rating:n,summary:a}))})))):t(new Error("User must be logged in")):t(new Error("Only Rating instance can be used"))}static set(e,t,n){if(!(t instanceof Rating))return n(new Error("Only Rating instance can be used"));t.lastUpdatedOn=new Date,buildfire.appData.update(t.id,t.toJSON(),Ratings.TAG,(t,a)=>{if(t)return n(t);a=new Rating(a),Summaries.updateRating(e,a,(e,t)=>n(null,{rating:a,summary:t}))})}static del(e,t){if(!(e instanceof Rating))return t(new Error("Only Rating instance can be used"));buildfire.appData.delete(e.id,Ratings.TAG,(n,a)=>{if(n)return t(n);Summaries.deleteRating(e,(n,a)=>(buildfire.messaging.sendMessageToControl({type:"ratings"}),t(null,{rating:e,summary:a})))})}static softDel(e,t){if(!(e instanceof Rating))return t(new Error("Only Rating instance can be used"));let n=e.isActive;e.isActive=!1,buildfire.appData.update(e.id,e.toJSON(),Ratings.TAG,(a,i)=>a?t(a):n?void Summaries.deleteRating(e,(n,a)=>(buildfire.messaging.sendMessageToControl({type:"ratings"}),t(null,e))):t(null,e))}}class Summary{constructor(e={}){e.data||(e.data={}),this.id=e.id||void 0,this.ratingId=e.data.ratingId||null,this.count=e.data.count||0,this.total=e.data.total||0}toJSON(){return{id:this.id,ratingId:this.ratingId,count:this.count,total:this.total,_buildfire:{index:{string1:this.ratingId}}}}}class Summaries{static get TAG(){return"fivestarsummary"}static search(e,t){buildfire.appData.search(e,Summaries.TAG,(e,n)=>e?t(e):t(null,n.map(e=>new Summary(e))))}static addRating(e,t){const n={filter:{"_buildfire.index.string1":e.ratingId}};buildfire.appData.search(n,Summaries.TAG,(n,a)=>{if(n)return t(n);let i=a[0];i?((i=new Summary(i)).count++,i.total+=e.rating,buildfire.appData.update(i.id,i.toJSON(),Summaries.TAG,(e,n)=>e?t(e):t(null,new Summary(n)))):(i=new Summary({data:{ratingId:e.ratingId,count:1,total:e.rating}}),buildfire.appData.insert(i.toJSON(),Summaries.TAG,!1,(e,n)=>e?t(e):t(null,new Summary(n))))})}static updateRating(e,t,n){const a={filter:{"_buildfire.index.string1":t.ratingId}};buildfire.appData.search(a,Summaries.TAG,(a,i)=>{if(a)return n(a);let r=new Summary(i[0]);r.total+=t.rating,r.total-=e.rating,buildfire.appData.update(r.id,r.toJSON(),Summaries.TAG,(e,t)=>e?n(e):n(null,new Summary(t)))})}static deleteRating(e,t){const n={filter:{"_buildfire.index.string1":e.ratingId}};buildfire.appData.search(n,Summaries.TAG,(n,a)=>{if(n)return t(n);let i=new Summary(a[0]);i.total-=e.rating,i.count--,buildfire.appData.update(i.id,i.toJSON(),Summaries.TAG,(e,n)=>e?t(e):t(null,new Summary(n)))})}}const FULL_STAR="&#9733;",ADMIN_TAG="bf_ratings_admin",defaultOptions={hideAverage:!0,showRatingsOnClick:!0,translations:{ratings:"Ratings",addRating:"Add Rating",updateRating:"Update Rating",leaveAReview:"Leave a review",writeAComment:"Write a comment",basedOn:"Based on",review:"Review",reviews:"Reviews",viewAll:"View All",overallRating:"Overall rating",emptyStateText:"No reivews yet. Be the first to leave a review!"}};function getNotRatedUI(e){for(let t=0;t<5;t++){let t=document.createElement("span");t.innerHTML=FULL_STAR,t.style.opacity="0.3",e.appendChild(t)}}function injectRatings(e=defaultOptions,t){console.log("INJECT RATINGS");let n=e.elements;void 0===n&&(n=document.querySelectorAll("[data-rating-id]"));for(let e=0;e<n.length;e++)n[e].replaceWith(n[e].cloneNode(!0));n=document.querySelectorAll("[data-rating-id]");let a=e.ratingIds;if(void 0===a&&(a=Array.from(n).map((e,t)=>{let n=e.dataset.ratingId;if(!n.includes("tinymce")||e.innerHTML.includes("★ ★ ★ ★ ★"))return n})),!0===e.pluginLevel){let e=buildfire.getContext().instanceId;a=a.map(t=>`${t}-${e}`)}const i={filter:{"_buildfire.index.string1":{$in:a}}};Summaries.search(i,(i,r)=>{if(i)return console.error(i);a.forEach((a,i)=>{if(!a)return;let s=r.find(e=>e.ratingId===a);e.notRated=!s,e.summary=s,e.onBackButtonClick=buildfire.navigation.onBackButtonClick,e.callback=t,injectAverageRating(n[i],a,e)})})}function injectAverageRating(e,t,n){if(!e)return console.error("Container not found in DOM");let a=e.cloneNode(!0);const i={filter:{"_buildfire.index.string1":t}};let r=2==e.innerHTML.split("★ ★ ★ ★ ★").length;const s=()=>{delete n.summary,e.innerHTML=a.innerHTML,injectAverageRating(e,t,n)};if(n&&n.summary){let a=n.summary.total/n.summary.count;createStarsUI(e,a,n,t,s,r)}else Summaries.search(i,(a,i)=>{if(a)return console.error(a);i&&i[0]&&0!==i[0].count||(i=[{total:0,count:1}]),n.summary=i[0];let l=i[0].total/i[0].count;createStarsUI(e,l,n,t,s,r)})}function applyStyling(){let e=document.getElementById("style-ratings");e&&e.parentElement.removeChild(e),e=document.createElement("style"),buildfire.appearance.getAppTheme((t,n)=>{const{backgroundColor:a,primaryTheme:i}=n.colors;e.innerHTML=`\n            .backgroundColorTheme {\n                background-color: ${a} !important;\n            }\n\n            .primaryTheme {\n                color: ${i} !important;\n            }\n        `,document.head.appendChild(e)})}function openAddRatingScreen(e,t=defaultOptions,n=(()=>{})){buildfire.auth.getCurrentUser((a,i)=>{if(a||!i)return buildfire.auth.login({allowCancel:!0,showMenu:!0},(t,n)=>{if(n)return openAddRatingScreen(e)});Ratings.findRatingByUser(e,i._id,(a,r)=>{let s,l=buildfire.navigation.onBackButtonClick;if(buildfire.navigation.onBackButtonClick=(()=>{closeAddRatingScreen(),buildfire.navigation.onBackButtonClick=l}),r&&!r.isActive){let e=document.createElement("div");return e.className="add-rating-screen",e.style.padding="10px",e.innerText="Your rating has been removed for violating community guildelines",document.body.appendChild(e)}r?s=new Rating({data:r}):r=new Rating({data:{createdBy:i._id,user:{_id:i._id,displayName:i.displayName,imageUrl:i.imageUrl},ratingId:e}});let d=document.createElement("div");d.className="add-rating-screen",d.addEventListener("click",e=>{"add-rating-screen"==e.target.className&&buildfire.navigation.onBackButtonClick()});let o=document.createElement("div");o.className="add-rating-screen-content backgroundColorTheme";let c=document.createElement("div");c.className="add-rating-header";let m=document.createElement("div");m.className="cancel-rating-button",m.innerHTML="&#10005;",m.addEventListener("click",()=>{closeAddRatingScreen()});let u=document.createElement("div");u.className="add-rating-title",u.innerText=r.id?t&&t.translations&&t.translations.updateRating||defaultOptions.translations.updateRating:t&&t.translations&&t.translations.addRating||defaultOptions.translations.addRating,c.appendChild(m),c.appendChild(u);let g=document.createElement("div");g.className="add-rating-subtitle",g.innerText=t&&t.translations&&t.translations.leaveAReview||defaultOptions.translations.leaveAReview;let p=()=>{for(let e=0;e<5;e++){document.getElementById("stars"+e).style.opacity=e<r.rating?"1":"0.3"}},f=document.createElement("div");f.className="rating-stars";for(let e=0;e<5;e++){let t=document.createElement("div");t.id="stars"+e,t.addEventListener("click",function(){r.rating=e+1,p()}),t.innerHTML=FULL_STAR,t.style.color="#fcb040",f.appendChild(t)}let h=()=>{y.innerText=r.comment?r.comment:t&&t.translations&&t.translations.writeAComment||defaultOptions.translations.writeAComment},v=document.createElement("div");v.className="add-rating-subtitle",v.innerText=t&&t.translations&&t.translations.writeAComment||defaultOptions.translations.writeAComment;let y=document.createElement("div");y.className="text-area",y.addEventListener("click",()=>{buildfire.input.showTextDialog({placeholder:t&&t.translations&&t.translations.writeAComment||defaultOptions.translations.writeAComment,saveText:"Save",defaultValue:y.innerText!==(t&&t.translations&&t.translations.writeAComment||defaultOptions.translations.writeAComment)?y.innerText:"",attachments:{images:{enable:!0,multiple:!0}}},(e,t)=>{e||t.cancelled||(r.comment=t.results[0].textValue,r.images=[...r.images,...t.results[0].images],h(),R())})});let b=document.createElement("images");b.className="review-images-container";const R=()=>{b.innerHTML="",r.images.forEach((e,t)=>{let n=document.createElement("div");n.className="review-image-container";let a=document.createElement("div");a.className="review-image-delete",a.innerHTML="✖",a.style.background="red",a.style.color="white";let i=document.createElement("img");i.className="review-image",i.src=buildfire.imageLib.resizeImage(e,{size:"s",aspect:"1:1"}),n.appendChild(i),n.appendChild(a),n.addEventListener("click",()=>{(e=>{r.images.splice(e,1),R()})(t)}),b.appendChild(n)})};let C=document.createElement("div");C.className="submit-button",C.innerText=r.id?t&&t.translations&&t.translations.updateRating||defaultOptions.translations.updateRating:t&&t.translations&&t.translations.addRating||defaultOptions.translations.addRating,C.addEventListener("click",()=>{r.id?Ratings.set(s,r,(e,a)=>{buildfire.navigation.onBackButtonClick(),buildfire.messaging.sendMessageToControl({type:"ratings"}),n(e,a),t.callback&&t.callback(e,a),buildfire.components.ratingSystem.onRating(a)}):Ratings.add(r,(e,a)=>{buildfire.navigation.onBackButtonClick(),closeAddRatingScreen(),buildfire.messaging.sendMessageToControl({type:"ratings"}),n(e,a),t.callback&&t.callback(e,a),buildfire.components.ratingSystem.onRating(a)})}),o.appendChild(c),o.appendChild(g),o.appendChild(f),o.appendChild(v),o.appendChild(y),o.appendChild(b),o.appendChild(C),d.appendChild(o),document.body.appendChild(d),R(),p(),h()})})}function closeAddRatingScreen(){let e=document.querySelector(".add-rating-screen");e&&document.body.removeChild(e)}function createRatingUI(e,t,n){let a=document.createElement("div");a.className="ratings-screen-rating",a.id=e.id,a.dataset.rating=JSON.stringify(e);let i=document.createElement("div");i.className="rating-header",a.appendChild(i);let r=document.createElement("img");r.className="rating-user-image",r.src=e.user&&e.user.imageUrl?e.user.imageUrl:"https://pluginserver.buildfire.com/styles/media/avatar-placeholder.png",r.src=buildfire.imageLib.resizeImage(r.src,{size:"s",aspect:"1:1"}),i.appendChild(r);let s=document.createElement("div");s.className="rating-name-and-stars",i.appendChild(s);let l=document.createElement("div");l.className="rating-user-display-name",l.innerText=e.user&&e.user.displayName?e.user.displayName:"Unknown User",t&&l.appendChild(t),s.appendChild(l);let d=document.createElement("div");d.className="rating-user-stars",s.appendChild(d);let o=document.createElement("span");o.className="stars-span",createStarsUI(o,Number(e.rating),{hideAverage:!0});let c=document.createElement("span");c.className="rating-time-ago",c.innerHTML=formatTime(new Date(e.createdOn)),d.appendChild(o),d.appendChild(c);let m=document.createElement("div");m.className="rating-review",a.appendChild(m);let u=document.createElement("div");if(u.className="rating-review-text",u.innerText=e.comment.length>120?e.comment.slice(0,120)+"...":e.comment,e.comment.length>120){let t=document.createElement("a");t.innerText="see more",t.addEventListener("click",()=>{u.innerText=e.comment}),u.append(t)}m.appendChild(u);let g=document.createElement("div");g.className="rating-review-images",m.appendChild(g);for(let t=0;t<e.images.length;t++){const n=e.images[t];let a=document.createElement("img");a.className="rating-review-image",a.src=buildfire.imageLib.resizeImage(n,{size:"m",aspect:"1:1"}),a.addEventListener("click",()=>{const n={images:e.images,index:t};buildfire.imagePreviewer.show(n,callback)}),g.appendChild(a)}return a}function openRatingsScreen(e,t,n){let a=document.createElement("div");a.id="ratingsScreenContainer",a.className="ratings-screen backgroundColorTheme",buildfire.spinner.show(),buildfire.navigation.onBackButtonClick=(()=>{t.callback&&t.callback(void 0,null),closeRatingsScreen(),buildfire.navigation.onBackButtonClick=t.onBackButtonClick});let i=document.createElement("div");i.className="ovarall-rating-container";let r=document.createElement("h5");r.innerText=t&&t.translations&&t.translations.overallRating||defaultOptions.translations.overallRating,r.style.fontWeight=400,r.style.fontSize="14px",i.appendChild(r);let s=document.createElement("h6");s.style.fontSize="12px",s.style.fontWeight="normal",i.appendChild(s);let l=document.createElement("div");l.className="overall-rating-stars",i.appendChild(l),a.appendChild(i);let d=document.createElement("div");a.appendChild(d);let o=document.createElement("div");o.className="empty-state-container";let c=document.createElement("h5");c.innerText=t&&t.translations&&t.translations.emptyStateText||defaultOptions.translations.emptyStateText,o.appendChild(c),Summaries.search({filter:{"_buildfire.index.string1":e}},(e,n)=>{if(e)return console.error(e);if(!n[0])return getNotRatedUI(l),a.appendChild(o);const{count:i,total:r}=n[0];createStarsUI(l,r/i,{hideAverage:!0}),s.innerText=`${t&&t.translations&&t.translations.basedOn||defaultOptions.translations.basedOn} ${i} ${t&&t.translations&&t.translations.reviews||defaultOptions.translations.reviews}`}),checkIfUserIsAdmin((r,s)=>{Ratings.findRatingByUser(e,r._id,(a,r)=>{if(a)return console.error(a);if(r){const a=document.createElement("div");a.className="edit-rating-button primaryTheme",a.innerText=t&&t.translations&&t&&t.translations&&t.translations.updateRating||defaultOptions.translations.updateRating,a.addEventListener("click",()=>{openAddRatingScreen(e,t,()=>{m(),n()})});let i=createRatingUI(r,a,t);s&&addControlsToRating(i),d.appendChild(i)}else{let a=document.createElement("div");a.className="add-rating-button primaryTheme",a.innerText=t&&t.translations&&t&&t.translations&&t.translations.addRating||defaultOptions.translations.addRating,a.addEventListener("click",()=>{openAddRatingScreen(e,t,()=>{m(),n()})}),i.appendChild(a)}}),Ratings.search({filter:{"_buildfire.index.string1":e,"_buildfire.index.number1":1,"_buildfire.index.array1":{$ne:r._id}}},(e,t)=>{if(e)return console.error(e);t.forEach(e=>{let t=createRatingUI(e);s&&addControlsToRating(t),a.appendChild(t)});const n=document.getElementById("ratingsScreenContainer");n&&document.body.removeChild(n),document.body.appendChild(a),buildfire.spinner.hide()})});const m=()=>{openRatingsScreen(e,t,n)}}function checkIfUserIsAdmin(e){buildfire.auth.getCurrentUser((t,n)=>t||!n?buildfire.auth.login({allowCancel:!0,showMenu:!0},(t,n)=>{if(n)return checkIfUserIsAdmin(e)}):n.tags?(Object.keys(n.tags).forEach(t=>{if(-1!=n.tags[t].findIndex(e=>e.tagName==ADMIN_TAG))return e(n,!0)}),e(n,!1)):e(n,!1))}function formatTime(e){return new Date(e).toLocaleDateString()}function closeRatingsScreen(){let e=document.querySelector(".ratings-screen");document.body.removeChild(e)}function createStarsUI(e,t,n,a,i,r){const{hideAverage:s,showRatingsOnClick:l}=n;let d,o;if(r){if(d=(d=e.innerHTML).split("★ ★ ★ ★ ★"),e.children&&e.children[0]&&(o=e.children[0].style).color){let e=document.createElement("style");e.innerHTML=`\n                    span.full-star {\n                        color: ${o.color} !important;\n                    }\n\n                    span.full-star span {\n                        color: ${o.color} !important;\n                    }\n                `,document.body.appendChild(e)}e.innerHTML=""}else e.innerHTML="",e.classList.add("flex-center");for(let n=1;n<6;n++){let a=document.createElement("span");if(a.innerHTML=FULL_STAR,a.className="full-star",n>t&&n===Math.trunc(t)+1){a.innerHTML=`<span style="opacity: 0.3">${FULL_STAR}</span>`;let e=100*(t-Math.trunc(t));a.style.position="relative";let n=document.createElement("span");n.innerHTML=FULL_STAR,n.className="half-star",n.style.backgroundImage=`linear-gradient(to right, currentColor ${e}%, transparent ${e}%)`,a.appendChild(n)}else n>t&&(a.style.opacity="0.3");e.appendChild(a)}if(!s&&t>0){let n=document.createElement("span");n.className="average-rating",n.innerText=t.toFixed(1),e.appendChild(n)}l&&(e.style.cursor="pointer",e.addEventListener("click",()=>{openRatingsScreen(a,n,i)})),r&&(d&&(e.innerHTML=d[0]+e.innerHTML+d[1]),o&&(e.style=e.style.cssText+o.cssText,e.children&&e.children[0]&&(e.children[0].style=e.style.cssText+o.cssText)))}function injectRatingComponent(e,t,n=defaultOptions){e.innerHTML="";let a=document.createElement("div");a.className="ratings";let i=document.createElement("div");i.className="reviews-container";let r=t;if(!0===n.pluginLevel){let e=buildfire.getContext().instanceId;t=`${t}-${e}`}a.addEventListener("click",()=>{openRatingsScreen(t,n,s)}),a.appendChild(i);Summaries.search({filter:{"_buildfire.index.string1":t}},(e,n)=>{if(e)return console.err(e);n&&n[0]&&0!==n[0].count||(n=[{total:0,count:1}]);let a=n[0].total/n[0].count;createStarsUI(i,a,{hideAverage:!0},t,s)}),e.appendChild(a);const s=()=>{injectRatingComponent(e,r,n)}}function addControlsToRating(e){let t=JSON.parse(e.dataset.rating);if(!(t=new Rating({data:t,id:t.id})).isActive){let t=document.createElement("div");t.innerText="This rating has been blocked",e.appendChild(t)}let n=document.createElement("div"),a=document.createElement("button");a.innerText="Delete",a.className="delete-button",a.addEventListener("click",()=>{buildfire.notifications.confirm({title:"Are you sure?",message:"Are you sure you want to remove this review?",confirmButton:{text:"Yes",key:"yes",type:"danger"},cancelButton:{text:"No",key:"no",type:"default"}},function(e,n){(e&&2!==e||n&&"yes"===n.selectedButton.key)&&Ratings.del(t,(e,t)=>{let n=document.getElementById(t.rating.id);n.parentElement.removeChild(n)})})});let i=document.createElement("button");i.innerText="Block",i.className="delete-button",i.addEventListener("click",()=>{buildfire.notifications.confirm({title:"Are you sure you want to block this review?",message:"User will not be able to submit another review for this item",confirmButton:{text:"Yes",key:"yes",type:"danger"},cancelButton:{text:"No",key:"no",type:"default"}},function(e,n){(e&&2!==e||n&&"yes"===n.selectedButton.key)&&Ratings.softDel(t,(e,t)=>{})})}),n.appendChild(a),n.appendChild(i),e.appendChild(n)}function onRating(){}buildfire.components.ratingSystem={injectRatings:injectRatings,injectRatingComponent:injectRatingComponent,openAddRatingScreen:openAddRatingScreen,openRatingsScreen:openRatingsScreen,onRating:onRating},applyStyling();